function e(e,n,t,i,r,o,a){try{var s=e[o](a),u=s.value}catch(e){t(e);return}s.done?n(u):Promise.resolve(u).then(i,r)}function n(n){return function(){var t=this,i=arguments;return new Promise(function(r,o){var a=n.apply(t,i);function s(n){e(a,r,o,s,u,"next",n)}function u(n){e(a,r,o,s,u,"throw",n)}s(void 0)})}}function t(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function i(e,n){var t,i,r,o,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(t)throw TypeError("Generator is already executing.");for(;a;)try{if(t=1,i&&(r=2&o[0]?i.return:o[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,o[1])).done)return r;switch(i=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,i=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(r=(r=a.trys).length>0&&r[r.length-1])&&(6===o[0]||2===o[0])){a=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){a.label=o[1];break}if(6===o[0]&&a.label<r[1]){a.label=r[1],r=o;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(o);break}r[2]&&a.ops.pop(),a.trys.pop();continue}o=n.call(e,a)}catch(e){o=[6,e],i=0}finally{t=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}}import{getModeByAppKey as r,getUrlsByMode as o,makeWepinResponseMessage as a,Platform as s,proxyToObject as u,WebviewEventHandler as p}from"@wepin/common";import{WepinFetch as l,WepinPlatformType as c,isErrorResponse as d}from"@wepin/fetch-js";import{WepinModal as w}from"@wepin/modal-js";import v from"@wepin/storage-js";import{jwtDecode as f}from"jwt-decode";import{PROVIDER_COOKIE_NAME as h}from"./const/cookieName.js";import{version as g}from"./const/version.js";import _ from"./ethereum/inPageProvider.js";import y from"./klaytn/inPageProvider.js";import m from"./solana/inPageProvider.js";import{getNetworkByChainId as b}from"./utils/info.js";import{getAddress as A}from"./utils/utils.js";export var WepinProvider=/*#__PURE__*/function(){var e;function k(e){var n=this,i=e.appId,r=e.appKey,o=e.modal,a=e.storage;!function(e,n){if(!(e instanceof n))throw TypeError("Cannot call a class as a function")}(this,k),t(this,"version",void 0),t(this,"type",void 0),t(this,"wepinDomain",void 0),t(this,"wepinAppAttributes",void 0),t(this,"wepinAppId",void 0),t(this,"_wepinAppKey",void 0),t(this,"_wepinFetch",void 0),t(this,"_wepinModal",void 0),t(this,"_widget",void 0),t(this,"_wepinStorage",void 0),t(this,"_isInitialized",!1),t(this,"_url",void 0),t(this,"webviewEventHandler",void 0),t(this,"queue",void 0),this.wepinAppId=i,this._wepinAppKey=r,this.version=g,this._wepinModal=null!=o?o:new w,this._wepinStorage=null!=a?a:new v,this.type=this._wepinStorage.platform,this.wepinDomain=this._wepinModal.domain,this.webviewEventHandler=new p({checkValidEvent:function(e){return!!(n.wepinWidget.url.includes("/wepin-sdk-login")||n.wepinWidget.url.includes(e.origin))||e.origin===n.wepinWidget.url}}),this.initEventHandler()}return e=[{key:"wepinStorage",get:function(){return this._wepinStorage}},{key:"initEventHandler",value:function(){var e,t,r=this;t="local_ak_dev_"===this._wepinAppKey.slice(0,13)?this._wepinAppKey.slice(6):this._wepinAppKey,this.webviewEventHandler.addRequestHandler("ready_to_widget",function(e){r.wepinStorage.getAllLocalStorage(r.wepinAppId).then(function(n){var i,o=Object.assign({},r.wepinAppAttributes),u=a(e,"SUCCESS",{appKey:t,appId:r.wepinAppId,domain:r.wepinDomain,platform:s[r.type],attributes:o,type:"".concat(r.type,"-provider"),version:r.version.includes("-alpha")?r.version.substring(0,r.version.indexOf("-")):r.version,localDate:null!=n?n:{}});(null===(i=r.wepinWidget)||void 0===i?void 0:i.isOpen)&&r.wepinWidget.response(u)})}),this.webviewEventHandler.addRequestHandler("close_wepin_widget",function(){r.wepinWidget.close()}),this.webviewEventHandler.addRequestHandler("dequeue_request",function(e){if(r.queue[0]){var n,t;t=a(e,"SUCCESS",u(r.queue[0]))}else t=a(e,"ERROR",null);(null===(n=r.wepinWidget)||void 0===n?void 0:n.isOpen)&&r.wepinWidget.response(t)});var o=this;this.webviewEventHandler.addRequestHandler("set_local_storage",(e=n(function(e){var n,t;return i(this,function(i){switch(i.label){case 0:return[4,o.wepinStorage.setAllLocalStorage(o.wepinAppId,e.body.parameter.data)];case 1:return i.sent(),t=a(e,"SUCCESS",""),(null===(n=o.wepinWidget)||void 0===n?void 0:n.isOpen)&&o.wepinWidget.response(t),[2]}})}),function(n){return e.apply(this,arguments)})),this.webviewEventHandler.addGlobalHandler("pre_response",function(e){var n=r.queue.findIndex(function(n){return n.header.id===e.header.id});-1!==n&&r.queue.splice(n,1)})}},{key:"_initQueue",value:function(){this.queue=new Proxy([],{})}},{key:"wepinModal",get:function(){return this._wepinModal}},{key:"wepinWidget",get:function(){return this._widget},set:function(e){this._widget=e}},{key:"changeLanguage",value:function(e){this.wepinAppAttributes={defaultLanguage:e.language,defaultCurrency:e.currency}}},{key:"init",value:function(e){var t=this;return n(function(){var n;return i(this,function(i){switch(i.label){case 0:return t._wepinFetch=new l({appId:t.wepinAppId,appKey:t._wepinAppKey,domain:t.wepinDomain,sdk:{version:t.version,type:"".concat(t.type,"-provider")},storage:t._wepinStorage}),[4,t._wepinFetch.init()];case 1:return i.sent(),[4,t._wepinFetch.wepinApi.app.getAppInfo({platform:c[t.type],withNetwork:!1})];case 2:if(d(n=i.sent()))throw Error(n.message);return t.wepinAppId=t._wepinFetch.appId=n.appInfo.id,t._url=o(r(t._wepinAppKey)).wepinWebview,t._isInitialized=!0,t.wepinAppAttributes=null!=e?e:{defaultCurrency:"USD",defaultLanguage:"en"},t._initQueue(),[2]}})})()}},{key:"isInitialized",value:function(){return this._isInitialized}},{key:"checkExpiredToken",value:function(){var e=this;return n(function(){var n,t,r;return i(this,function(i){switch(i.label){case 0:return i.trys.push([0,8,,9]),[4,e._wepinStorage.getLocalStorage(e.wepinAppId,"wepin:connectUser")];case 1:if(!(n=i.sent()))return[2,!0];if(!(f(n.accessToken).exp<Math.floor(Date.now()/1e3)+60))return[3,6];return[4,e._wepinFetch.setToken(n)];case 2:return i.sent(),[4,e._wepinStorage.getLocalStorage(e.wepinAppId,"user_id")];case 3:return t=i.sent(),[4,e._wepinFetch.wepinApi.user.refreshToken({userId:t})];case 4:if(d(r=i.sent()))return[2,!0];return n.accessToken=r.token,[4,e._wepinStorage.setLocalStorage(e.wepinAppId,"wepin:connectUser",n)];case 5:return i.sent(),[2,!1];case 6:return[2,!1];case 7:return[3,9];case 8:return i.sent(),[2,!0];case 9:return[2]}})})()}},{key:"getProvider",value:function(e){var t=this;return n(function(){var n,r,o,a,s,u,p,l,c,w,v,f,h,g,k,S,I,W,E,L,P,j,H,C;return i(this,function(i){switch(i.label){case 0:if(!1===t._isInitialized)throw Error("WepinProvider is not initialized yet. Please call init() method first.");if(!(null===(n=window.evmproviders)||void 0===n?void 0:n.Wepin))return[3,7];return[4,b(null===(a=window.evmproviders)||void 0===a?void 0:a.Wepin.chainId,!0)];case 1:return p=A(u=i.sent(),null===(s=window.evmproviders)||void 0===s?void 0:s.Wepin.selectedAddress),[4,t.checkExpiredToken()];case 2:if(i.sent())return[3,6];return[4,t._wepinStorage.getLocalStorage(t.wepinAppId,"wallet_id")];case 3:return l=i.sent(),[4,t._wepinStorage.getLocalStorage(t.wepinAppId,"user_id")];case 4:return c=i.sent(),[4,t._wepinFetch.wepinApi.account.getAppAccountList({walletId:l,userId:c,localeId:"ko"===t.wepinAppAttributes.defaultLanguage?1:"ja"===t.wepinAppAttributes.defaultLanguage?3:2})];case 5:if(!d(w=i.sent())&&((null===(v=w.aa_accounts)||void 0===v?void 0:v.length)?w.accounts.concat(w.aa_accounts):null!==(f=w.accounts)&&void 0!==f?f:[]).filter(function(e){return A(u,e.address)===p&&e.network.toLowerCase()===u}).length)return[2,window.evmproviders.Wepin];i.label=6;case 6:return[3,13];case 7:if(!(null===(o=window.wepin)||void 0===o?void 0:null===(r=o.solana)||void 0===r?void 0:r.Wepin))return[3,13];return[4,b(null===(g=window.wepin)||void 0===g?void 0:null===(h=g.solana)||void 0===h?void 0:h.Wepin.chainId,!0)];case 8:return W=A(I=i.sent(),null===(S=window.wepin)||void 0===S?void 0:null===(k=S.solana)||void 0===k?void 0:k.Wepin.publicKey),[4,t.checkExpiredToken()];case 9:if(i.sent())return[3,13];return[4,t._wepinStorage.getLocalStorage(t.wepinAppId,"wallet_id")];case 10:return E=i.sent(),[4,t._wepinStorage.getLocalStorage(t.wepinAppId,"user_id")];case 11:return L=i.sent(),[4,t._wepinFetch.wepinApi.account.getAppAccountList({walletId:E,userId:L,localeId:"ko"===t.wepinAppAttributes.defaultLanguage?1:"ja"===t.wepinAppAttributes.defaultLanguage?3:2})];case 12:if(!d(P=i.sent())&&((null===(j=P.aa_accounts)||void 0===j?void 0:j.length)?P.accounts.concat(P.aa_accounts):null!==(H=P.accounts)&&void 0!==H?H:[]).filter(function(e){return A(I,e.address)===W&&e.network.toLowerCase()===I}).length)return[2,window.wepin.solana.Wepin];i.label=13;case 13:if(!((C=e.toLowerCase()).startsWith("evm")||"ethereum"===C))return[3,15];return[4,_.generate({network:C,wepinProvider:t})];case 14:case 16:case 18:return[2,i.sent()];case 15:if(!C.startsWith("klaytn"))return[3,17];return[4,y.generate({network:C,wepinProvider:t})];case 17:if(!C.startsWith("solana"))return[3,19];return[4,m.generate({network:C,wepinProvider:t})];case 19:throw Error("Can not resolve network name: ".concat(e));case 20:return[2]}})})()}},{key:"openModal",value:function(){var e=this;return n(function(){return i(this,function(n){switch(n.label){case 0:return[4,e.wepinModal.openModal(e._url,e.webviewEventHandler.getEventListenerFunction())];case 1:return e._widget=n.sent(),[2]}})})()}},{key:"finalize",value:function(){var e=this;return n(function(){var n;return i(this,function(t){switch(t.label){case 0:return[4,e._wepinStorage.clearLocalStorage(h+e.wepinAppId,"selectedAddress")];case 1:return t.sent(),e._initQueue(),window.evmproviders&&(window.evmproviders.Wepin=null),(null===(n=window.wepin)||void 0===n?void 0:n.solana)&&(window.wepin.solana.Wepin=null),e._isInitialized=!1,[2]}})})()}}],function(e,n){for(var t=0;t<n.length;t++){var i=n[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}(k.prototype,e),k}();