function e(e){if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function t(e,t,n,i,r,o,a){try{var s=e[o](a),u=s.value}catch(e){n(e);return}s.done?t(u):Promise.resolve(u).then(i,r)}function n(e){return function(){var n=this,i=arguments;return new Promise(function(r,o){var a=e.apply(n,i);function s(e){t(a,r,o,s,u,"next",e)}function u(e){t(a,r,o,s,u,"throw",e)}s(void 0)})}}function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e){return(r=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function o(e,t){return(o=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function a(e,t){var n,i,r,o,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(n)throw TypeError("Generator is already executing.");for(;a;)try{if(n=1,i&&(r=2&o[0]?i.return:o[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,o[1])).done)return r;switch(i=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,i=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(r=(r=a.trys).length>0&&r[r.length-1])&&(6===o[0]||2===o[0])){a=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){a.label=o[1];break}if(6===o[0]&&a.label<r[1]){a.label=r[1],r=o;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(o);break}r[2]&&a.ops.pop(),a.trys.pop();continue}o=t.call(e,a)}catch(e){o=[6,e],i=0}finally{n=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}}function s(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],i=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&i>=e.length&&(e=void 0),{value:e&&e[i++],done:!e}}};throw TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}import u from"@metamask/safe-event-emitter";import{getUrlsByMode as c,getModeByAppKey as l,WebviewEventHandler as p,Platform as d,proxyToObject as f,makeWepinResponseMessage as w}from"@wepin/common";import{WepinFetch as g,isErrorResponse as h,WepinPlatformType as _}from"@wepin/fetch-js";import{WepinModal as v}from"@wepin/modal-js";import y from"@wepin/storage-js";import{jwtDecode as b}from"jwt-decode";import m from"../package.json";import{WEPIN_DEFAULT_CURRENCY as S,WEPIN_DEFAULT_LANG as A}from"./const/config";import{emailRegExp as I}from"./const/regExp";import{WEPIN_SDK_EVENTS as E}from"./types";import{filterAccountBalance as k}from"./utils/accountBalance";import{filterAccountList as L,getAccountSDK as W}from"./utils/accounts";import C from"./utils/log";export var WepinSDK=function(t){!function(e,t){if("function"!=typeof t&&null!==t)throw TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&o(e,t)}(R,t);var u,O,z=(u=function(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}(),function(){var t,n=r(R);return t=u?Reflect.construct(n,arguments,r(this).constructor):n.apply(this,arguments),t&&("object"==(t&&"undefined"!=typeof Symbol&&t.constructor===Symbol?"symbol":typeof t)||"function"==typeof t)?t:e(this)});function R(t){var n,r=t.appId,o=t.appKey,a=t.wepinModal,s=t.wepinStorage;return!function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,R),i(e(n=z.call(this)),"version",void 0),i(e(n),"type",void 0),i(e(n),"wepinAppAttributes",void 0),i(e(n),"wepinDomain",void 0),i(e(n),"specifiedEmail",void 0),i(e(n),"_wepinLifeCycle",void 0),i(e(n),"_isInitialized",void 0),i(e(n),"_modeByAppKey",void 0),i(e(n),"_wepinAppId",void 0),i(e(n),"_wepinAppKey",void 0),i(e(n),"_widget",void 0),i(e(n),"_wepinModal",void 0),i(e(n),"_wepinStorage",void 0),i(e(n),"_wepinFetch",void 0),i(e(n),"_accountInfo",void 0),i(e(n),"_detailAccount",void 0),i(e(n),"_userInfo",void 0),i(e(n),"webviewEventHandler",void 0),i(e(n),"wepinRequest",void 0),n.version=m.version,console.log("WepinWeb SDK v".concat(n.version)),n._isInitialized=!1,n.wepinLifeCycle="not_initialized",n._wepinAppId=r,n._wepinAppKey=o,n._wepinModal=a||new v,n._wepinStorage=s||new y,n.type=n._wepinStorage.platform,n._modeByAppKey=l(o),n.webviewEventHandler=new p({checkValidEvent:function(e){return!!(n.wepinWidget.url.includes("/wepin-sdk-login")||n.wepinWidget.url.includes(e.origin))||e.origin===n.wepinWidget.url}}),n.initEventHandler(),n}return O=[{key:"initEventHandler",value:function(){var e,t,i=this;t="local_ak_dev_"===this._wepinAppKey.slice(0,13)?this._wepinAppKey.slice(6):this._wepinAppKey,this.webviewEventHandler.addRequestHandler("ready_to_widget",function(e){i.wepinStorage.getAllLocalStorage(i._wepinAppId).then(function(n){var r,o,a,s=Object.assign({},i.wepinAppAttributes),u=(null===(r=i.wepinAppAttributes.loginProviders)||void 0===r?void 0:r.length)||(null===(o=i.wepinAppAttributes.loginProviders)||void 0===o?void 0:o.length)===0?Array.from(i.wepinAppAttributes.loginProviders):void 0;s.loginProviders=u;var c=w(e,"SUCCESS",{appKey:t,appId:i._wepinAppId,domain:i.wepinDomain,platform:d[i.type],attributes:s,version:i.version.includes("-alpha")?i.version.substring(0,i.version.indexOf("-")):i.version,type:"".concat(i.type,"-sdk"),localDate:null!=n?n:{}});(null===(a=i.wepinWidget)||void 0===a?void 0:a.isOpen)&&i.wepinWidget.response(c)})}),this.webviewEventHandler.addRequestHandler("close_wepin_widget",function(){i.wepinWidget&&(i.wepinWidget.close(),i.wepinWidget=void 0)});var r=this;this.webviewEventHandler.addRequestHandler("set_local_storage",(e=n(function(e){var t,n,i,o;return a(this,function(a){switch(a.label){case 0:return[4,r.wepinStorage.setAllLocalStorage(r._wepinAppId,e.body.parameter.data)];case 1:if(a.sent(),e.body.parameter.data&&e.body.parameter.data.user_info&&(n=e.body.parameter.data.user_info,i=e.body.parameter.data.user_status,n.userStatus=i,r.setUserInfo(n,!0)),!(e.body.parameter.data&&e.body.parameter.data["wepin:connectUser"]))return[3,3];return[4,r.setToken(e.body.parameter.data["wepin:connectUser"])];case 2:a.sent(),a.label=3;case 3:return o=w(e,"SUCCESS",""),(null===(t=r.wepinWidget)||void 0===t?void 0:t.isOpen)&&r.wepinWidget.response(o),[2]}})}),function(t){return e.apply(this,arguments)})),this.webviewEventHandler.addRequestHandler("set_user_email",function(e){var t,n=w(e,"SUCCESS",{email:i.specifiedEmail});(null===(t=i.wepinWidget)||void 0===t?void 0:t.isOpen)&&i.wepinWidget.response(n)}),this.webviewEventHandler.addRequestHandler("get_sdk_request",function(e){var t,n,r=w(e,"SUCCESS",null!==(n=f(i.getSDKRequest()))&&void 0!==n?n:"No request");(null===(t=i.wepinWidget)||void 0===t?void 0:t.isOpen)&&i.wepinWidget.response(r)})}},{key:"wepinLifeCycle",get:function(){return this._wepinLifeCycle},set:function(e){if(e!==this._wepinLifeCycle){if(this._wepinLifeCycle=e,"login"===this._wepinLifeCycle||"login_before_register"===this._wepinLifeCycle){this.emit(E.WEPIN_LIFECYCLE_CHANGE,e,this._userInfo);return}this.emit(E.WEPIN_LIFECYCLE_CHANGE,e)}}},{key:"modeByAppKey",get:function(){if(void 0===this._modeByAppKey)throw Error("Wepin.modeByAppKey: wepin widget has to be initialized");return this._modeByAppKey}},{key:"toJSON",value:function(){return""}},{key:"wepinStorage",get:function(){return this._wepinStorage}},{key:"init",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{type:"hide",defaultLanguage:A,defaultCurrency:S},t=this;return n(function(){var n,i,r,o,s;return a(this,function(a){switch(a.label){case 0:if(t._isInitialized)throw Error("Wepin is already initialized!");return e&&(e.defaultLanguage=null!==(n=e.defaultLanguage)&&void 0!==n?n:A,e.defaultCurrency=null!==(i=e.defaultCurrency)&&void 0!==i?i:S,e.type=null!==(r=e.type)&&void 0!==r?r:"hide"),t.wepinAppAttributes=e,t.wepinDomain=t._wepinModal.domain,t._isInitialized=!1,t.wepinLifeCycle="initializing",t._wepinFetch=new g({appId:t._wepinAppId,appKey:t._wepinAppKey,domain:t.wepinDomain,sdk:{version:t.version,type:"".concat(t.type,"-sdk")},storage:t._wepinStorage}),[4,t._wepinFetch.init()];case 1:return a.sent(),[4,t._wepinFetch.wepinApi.app.getAppInfo({platform:_[t.type],withNetwork:!1})];case 2:if(h(o=a.sent()))throw Error(o.message);return t._wepinAppId=t._wepinFetch.appId=o.appInfo.id,[4,t._wepinStorage.getLocalStorage(t._wepinAppId,"wepin:connectUser")];case 3:if(!(s=a.sent()))return[3,5];return[4,t._wepinFetch.setToken(s)];case 4:a.sent(),a.label=5;case 5:return t._isInitialized=!0,[4,t.checkExpiredToken()];case 6:return a.sent(),[2]}})})()}},{key:"wepinWidget",get:function(){return this._widget},set:function(e){this._widget=e}},{key:"isInitialized",value:function(){return!!this._isInitialized}},{key:"changeLanguage",value:function(e){var t=e.currency,n=e.language;this.wepinAppAttributes.defaultCurrency=t,this.wepinAppAttributes.defaultLanguage=n}},{key:"openWidget",value:function(){var e=this;return n(function(){return a(this,function(t){switch(t.label){case 0:return[4,e.getStatus()];case 1:if("login"!==t.sent())throw Error("Wepin.openWidget: You can open it only if you are logged in to the wepin.");return[4,e._open()];case 2:return t.sent(),[2]}})})()}},{key:"_open",value:function(e){var t=this;return n(function(){var n,i;return a(this,function(r){switch(r.label){case 0:if(r.trys.push([0,7,,8]),n=c(t._modeByAppKey).wepinWebview,t._widget&&t._widget.isOpen)return[2];if((null==e?void 0:e.url)&&(n+=e.url),!((null==e?void 0:e.isHide)||"show"!==t.wepinAppAttributes.type&&(null==e?void 0:e.isInit)))return[3,2];return[4,t._wepinModal.openModal(n,t.webviewEventHandler.getEventListenerFunction(),{isHide:!0})];case 1:case 3:return t._widget=r.sent(),[3,6];case 2:if((null==e?void 0:e.type)!=="WINDOW")return[3,4];return[4,t._wepinModal.openAuthBrowser(n,t.webviewEventHandler.getEventListenerFunction())];case 4:return[4,t._wepinModal.openModal(n,t.webviewEventHandler.getEventListenerFunction())];case 5:t._widget=r.sent(),r.label=6;case 6:return[3,8];case 7:throw i=r.sent(),C.error(i),Error("Wepin.openWidget: Can't open wepin sdk widget");case 8:return[2]}})})()}},{key:"closeWidget",value:function(){if(!this._isInitialized)throw Error("Wepin.closeWidget: wepin sdk has to be initialized");if(this._widget)this._close();else throw Error("Wepin.closeWidget: wepin sdk widget is not exist")}},{key:"_close",value:function(){this.removeAllListeners("onUserInfoSet"),this.wepinRequest&&this.removeAllListeners(this.wepinRequest.header.id.toString()),this._widget&&(this._widget.close(),this._widget=void 0),this.specifiedEmail=void 0}},{key:"setToken",value:function(e){var t=this;return n(function(){return a(this,function(n){switch(n.label){case 0:return[4,t._wepinFetch.setToken(e)];case 1:return n.sent(),[2]}})})()}},{key:"checkExpiredToken",value:function(){var e=this;return n(function(){var t,n,i;return a(this,function(r){switch(r.label){case 0:return r.trys.push([0,8,,9]),[4,e._wepinStorage.getLocalStorage(e._wepinAppId,"wepin:connectUser")];case 1:if(!(t=r.sent()))return e.wepinLifeCycle="initialized",[2,!0];if(!(b(t.accessToken).exp<Math.floor(Date.now()/1e3)+60))return[3,6];return[4,e._wepinFetch.setToken(t)];case 2:return r.sent(),[4,e._wepinStorage.getLocalStorage(e._wepinAppId,"user_id")];case 3:return n=r.sent(),[4,e._wepinFetch.wepinApi.user.refreshToken({userId:n})];case 4:if(h(i=r.sent()))return e.wepinLifeCycle="initialized",[2,!0];return t.accessToken=i.token,[4,e._wepinStorage.setLocalStorage(e._wepinAppId,"wepin:connectUser",t)];case 5:r.sent(),r.label=6;case 6:return[4,e.getWepinUserInfo()];case 7:return r.sent(),[2,!1];case 8:return r.sent(),[2,!0];case 9:return[2]}})})()}},{key:"loginWithUI",value:function(e){var t=this;return n(function(){var i,r;return a(this,function(o){switch(o.label){case 0:if(!t._isInitialized)throw Error("Wepin.loginWithUI: wepin sdk has to be initialized");return[4,t._wepinStorage.getLocalStorage(t._wepinAppId,"wepin:connectUser")];case 1:return i=o.sent(),[4,t._wepinStorage.getLocalStorage(t._wepinAppId,"user_info")];case 2:if(r=o.sent(),null==e?void 0:e.email){if(!I.test(null==e?void 0:e.email))throw Error("Wepin.loginWithUI: The email does not match the correct format.");t.specifiedEmail=null==e?void 0:e.email}else t.specifiedEmail=void 0;if(t.wepinLifeCycle="before_login",!(i&&r))return[3,6];if(!(r&&(null==i?void 0:i.refreshToken)&&(null==e?void 0:e.email)&&(null==r?void 0:r.userInfo.email)!==(null==e?void 0:e.email)))return[3,4];return[4,t.logout()];case 3:o.sent(),o.label=4;case 4:if(!(null==i?void 0:i.refreshToken))return[3,6];return[4,t.checkExpiredToken()];case 5:if(!o.sent()&&r&&"success"===r.status)return[2,t._userInfo];o.label=6;case 6:return[4,t._open()];case 7:return o.sent(),[2,new Promise(function(e,i){t.once("onUserInfoSet",n(function(){var n;return a(this,function(r){switch(r.label){case 0:return r.trys.push([0,4,,5]),[4,t._wepinStorage.getLocalStorage(t._wepinAppId,"wepin:connectUser")];case 1:if(n=r.sent(),t._close(),t.specifiedEmail=void 0,!n)return i(Error("User canceled login")),[2];return[4,t._wepinFetch.setToken(n)];case 2:return r.sent(),[4,t.getWepinUserInfo()];case 3:return r.sent(),e(t._userInfo),[3,5];case 4:return i(Error(r.sent())),[3,5];case 5:return[2]}})}))})]}})})()}},{key:"getWepinUserInfo",value:function(e){var t=this;return n(function(){var n,i;return a(this,function(r){switch(r.label){case 0:return[4,t._wepinStorage.getLocalStorage(t._wepinAppId,"user_info")];case 1:return n=r.sent(),[4,t._wepinStorage.getLocalStorage(t._wepinAppId,"user_status")];case 2:if(i=r.sent(),!e)return[3,7];return n.walletId=e,[4,t._wepinStorage.setLocalStorage(t._wepinAppId,"user_status",{loginStatus:"complete"})];case 3:return r.sent(),[4,t._wepinStorage.setLocalStorage(t._wepinAppId,"user_info",n)];case 4:return r.sent(),[4,t._wepinStorage.setLocalStorage(t._wepinAppId,"wallet_id",e)];case 5:return r.sent(),[4,t._wepinStorage.setLocalStorage(t._wepinAppId,"user_status",{loginStatus:"complete"})];case 6:r.sent(),r.label=7;case 7:return t._userInfo=Object.assign(n,{userStatus:i}),n&&"success"===n.status?i&&"complete"===i.loginStatus?t.wepinLifeCycle="login":t.wepinLifeCycle="login_before_register":t.wepinLifeCycle="initialized",[2,t._userInfo]}})})()}},{key:"register",value:function(){var e=this;return n(function(){var t,i,r,o,s,u;return a(this,function(c){switch(c.label){case 0:if(!e._isInitialized)throw Error("Wepin.register: wepin sdk has to be initialized");return[4,e._wepinStorage.getLocalStorage(e._wepinAppId,"user_status")];case 1:return("registerRequired"===(t=c.sent()).loginStatus||"pinRequired"===t.loginStatus)&&e.wepinLifeCycle,[4,e.getStatus()];case 2:if("login_before_register"!==c.sent())throw Error("Wepin.register: The LifeCycle of wepin sdk has to be login_before_register");if("registerRequired"!==t.loginStatus&&"pinRequired"!==t.loginStatus)throw Error("Wepin.register: invalid login status");if(!("registerRequired"===t.loginStatus&&!t.pinRequired))return[3,8];return[4,e._wepinStorage.getLocalStorage(e._wepinAppId,"user_id")];case 3:return i=c.sent(),[4,e._wepinStorage.getLocalStorage(e._wepinAppId,"wallet_id")];case 4:return r=c.sent(),[4,e._wepinFetch.wepinApi.app.register({appId:e._wepinAppId,userId:i,walletId:r,loginStatus:t.loginStatus})];case 5:if(h(o=c.sent()))throw Error(o.message);return[4,e._wepinFetch.wepinApi.user.updateTermsAccepted({userId:i},{termsAccepted:{termsOfService:!0,privacyPolicy:!0}})];case 6:if(h(s=c.sent())||!Object.values(s.termsAccepted).every(function(e){return!0===e}))throw Error("unknown/updateTermsAccepted");return[4,e.getWepinUserInfo(o.walletId)];case 7:return[2,c.sent()];case 8:return u=new Date().getTime(),e.wepinRequest={header:{request_from:"web",request_to:"wepin_widget",id:u},body:{command:"register_wepin",parameter:{loginStatus:t.loginStatus,pinRequired:t.pinRequired}}},[2,new Promise(function(t,i){var r;e.webviewEventHandler.addResponseHandler(u.toString(),(r=n(function(n){var r,o;return a(this,function(a){switch(a.label){case 0:if(e.wepinRequest=void 0,e._close(),"SUCCESS"!==n.body.state)return[3,2];return o=null===(r=n.body.data)||void 0===r?void 0:r.walletId,[4,e.getWepinUserInfo(o)];case 1:return a.sent(),t(e._userInfo),[3,3];case 2:n.body.data?i(Error("Wepin.register: ".concat(n.body.data))):i(Error("unknown/error")),a.label=3;case 3:return[2]}})}),function(e){return r.apply(this,arguments)}),!0),e._open({url:"/sdk-register"})})];case 9:return[2]}})})()}},{key:"logout",value:function(){var e=this;return n(function(){var t;return a(this,function(n){switch(n.label){case 0:return[4,e.getStatus()];case 1:if(t=n.sent(),!e._isInitialized)throw Error("Wepin.logout: wepin sdk has to be initialized");if("login"!==t&&"login_before_register"!==t)throw Error("Wepin.logout: Only if you're logged in to the wepin");return[4,e._wepinStorage.clearAllLocalStorage(e._wepinAppId)];case 2:return n.sent(),e.wepinLifeCycle="initialized",e._userInfo=void 0,e._accountInfo=void 0,e._detailAccount=void 0,[2]}})})()}},{key:"getAccounts",value:function(e){var t=this;return n(function(){var n,i,r;return a(this,function(o){switch(o.label){case 0:if(!t._isInitialized)throw Error("Wepin.getAccounts: wepin sdk has to be initialized");return[4,t.getStatus()];case 1:if("login"!==o.sent())throw Error("Wepin.getAccounts: Only if you're logged in to the wepin");return[4,t._wepinStorage.getLocalStorage(t._wepinAppId,"user_id")];case 2:return n=o.sent(),[4,t._wepinStorage.getLocalStorage(t._wepinAppId,"wallet_id")];case 3:return i=o.sent(),[4,t._wepinFetch.wepinApi.account.getAppAccountList({userId:n,walletId:i,localeId:"ko"===t.wepinAppAttributes.defaultLanguage?1:2})];case 4:if(h(r=o.sent()))throw Error(r.message);if(t._detailAccount=L(r,null==e?void 0:e.withEoa),t._accountInfo=W(t._detailAccount),(null==e?void 0:e.networks)!==void 0&&(null==e?void 0:e.networks.length)>0)return[2,t._accountInfo.filter(function(t){return(null==e?void 0:e.networks.findIndex(function(e){return e===t.network}))>=0})];return[2,t._accountInfo]}})})()}},{key:"setUserInfo",value:function(e,t){this._userInfo=e,e&&"success"===e.status?e.userStatus&&"complete"===e.userStatus.loginStatus?this.wepinLifeCycle="login":this.wepinLifeCycle="login_before_register":this.wepinLifeCycle="initialized",t&&this.emit("onUserInfoSet",e)}},{key:"getStatus",value:function(){var e=this;return n(function(){return a(this,function(t){switch(t.label){case 0:return[4,e.checkExpiredToken()];case 1:return t.sent(),[2,e.wepinLifeCycle]}})})()}},{key:"getBalance",value:function(e){var t=this;return n(function(){var n,i,r,o,u,c,l,p,d,f,w,g,_,v,y;return a(this,function(b){switch(b.label){case 0:if(!t._isInitialized)throw Error("Wepin.getBalance: wepin sdk has to be initialized");return[4,t.getStatus()];case 1:if("login"!==b.sent())throw Error("Wepin.getBalance: Only if you're logged in to the wepin.");return n=!e||0===e.length,i=[],[4,t.getAccounts()];case 2:if(b.sent(),!n)return[3,11];r=!0,o=!1,u=void 0,b.label=3;case 3:b.trys.push([3,8,9,10]),c=function(){var n,r;return a(this,function(o){switch(o.label){case 0:if(n=p.value,!(e&&e.findIndex(function(e){return e.network===n.network&&e.address===n.address})>=0))return[3,2];return[4,t._wepinFetch.wepinApi.balance.getAccountBalance({accountId:n.accountId})];case 1:if(h(r=o.sent()))throw Error(r.message);i.push(k(t._detailAccount,n,r)),o.label=2;case 2:return[2]}})},l=t._detailAccount[Symbol.iterator](),b.label=4;case 4:if(r=(p=l.next()).done)return[3,7];return[5,s(c())];case 5:b.sent(),b.label=6;case 6:return r=!0,[3,4];case 7:return[3,10];case 8:return d=b.sent(),o=!0,u=d,[3,10];case 9:try{r||null==l.return||l.return()}finally{if(o)throw u}return[7];case 10:return[3,19];case 11:f=!0,w=!1,g=void 0,b.label=12;case 12:b.trys.push([12,17,18,19]),_=function(){var e,n,r;return a(this,function(o){switch(o.label){case 0:if(e=y.value,!(n=t._detailAccount.find(function(t){return e.network===t.network&&e.address===t.address})))throw Error("Wepin.getBalance: Account not found");return[4,t._wepinFetch.wepinApi.balance.getAccountBalance({accountId:n.accountId})];case 1:if(h(r=o.sent()))throw Error(r.message);return i.push(k(t._detailAccount,n,r)),[2]}})},v=e[Symbol.iterator](),b.label=13;case 13:if(f=(y=v.next()).done)return[3,16];return[5,s(_())];case 14:b.sent(),b.label=15;case 15:return f=!0,[3,13];case 16:return[3,19];case 17:return d=b.sent(),w=!0,g=d,[3,19];case 18:try{f||null==v.return||v.return()}finally{if(w)throw g}return[7];case 19:if(!i.length)throw Error("Wepin.getBalance: Account not found");return[2,i]}})})()}},{key:"getSDKRequest",value:function(){return this.wepinRequest}},{key:"send",value:function(e){var t=e.account,i=e.txData,r=this;return n(function(){var e;return a(this,function(n){switch(n.label){case 0:if(!r._isInitialized)throw Error("Wepin.send: wepin sdk has to be initialized");return[4,r.getStatus()];case 1:if("login"!==n.sent())throw Error("Wepin.send: Only if you're logged in to the wepin");return r.emit(E.SEND_IN_PROGRESS),[4,r.getAccounts()];case 2:if(n.sent(),!r._detailAccount.find(function(e){return t.network===e.network&&t.address===e.address}))throw r.emit(E.SEND_COMPLETE,!1,"Account not found"),Error("Wepin.send: Account not found");return e=new Date().getTime(),r.wepinRequest={header:{request_from:"web",request_to:"wepin_widget",id:e},body:{command:"send_transaction_without_provider",parameter:{account:{address:t.address,network:t.network,contract:null==t?void 0:t.contract},from:t.address,to:null==i?void 0:i.toAddress,value:null==i?void 0:i.amount}}},[2,new Promise(function(t,n){r.webviewEventHandler.addResponseHandler(e.toString(),function(e){var i="SUCCESS"===e.body.state;if(r.wepinRequest=void 0,r._close(),i){var o=e.body.data;r.emit(E.SEND_COMPLETE,i,o),t({txId:o})}else e.body.data?(r.emit(E.SEND_COMPLETE,i,e.body.data),n(Error("Wepin.send: ".concat(e.body.data)))):(r.emit(E.SEND_COMPLETE,i,"unknown/error"),n(Error("unknown/error")))},!0),r._open({url:"/sdk-send"})})]}})})()}},{key:"finalize",value:function(){var e=this;return n(function(){return a(this,function(t){switch(t.label){case 0:return e._close(),[4,e._wepinStorage.clearAllLocalStorage(e._wepinAppId)];case 1:return t.sent(),e._isInitialized=!1,e.wepinLifeCycle="not_initialized",e._userInfo=void 0,e._accountInfo=void 0,e._detailAccount=void 0,e.specifiedEmail=void 0,[2]}})})()}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}(R.prototype,O),R}(u);