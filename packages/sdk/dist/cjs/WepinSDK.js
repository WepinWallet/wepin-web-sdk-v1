"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),Object.defineProperty(exports,"WepinSDK",{enumerable:!0,get:function(){return S}});var e=/*#__PURE__*/h(require("@metamask/safe-event-emitter")),t=require("@wepin/common"),n=require("@wepin/fetch-js"),i=require("@wepin/modal-js"),r=/*#__PURE__*/h(require("@wepin/storage-js")),o=require("jwt-decode"),s=require("./const/config.js"),a=require("./const/regExp.js"),u=require("./const/version.js"),c=require("./types/index.js"),l=require("./utils/accountBalance.js"),p=require("./utils/accounts.js"),d=/*#__PURE__*/h(require("./utils/log.js"));function f(e,t,n,i,r,o,s){try{var a=e[o](s),u=a.value}catch(e){n(e);return}a.done?t(u):Promise.resolve(u).then(i,r)}function w(e){return function(){var t=this,n=arguments;return new Promise(function(i,r){var o=e.apply(t,n);function s(e){f(o,i,r,s,a,"next",e)}function a(e){f(o,i,r,s,a,"throw",e)}s(void 0)})}}function g(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _(e){return(_=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function h(e){return e&&e.__esModule?e:{default:e}}function v(e,t){return(v=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function y(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(y=function(){return!!e})()}function b(e,t){var n,i,r,o,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(n)throw TypeError("Generator is already executing.");for(;s;)try{if(n=1,i&&(r=2&o[0]?i.return:o[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,o[1])).done)return r;switch(i=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,i=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(r=(r=s.trys).length>0&&r[r.length-1])&&(6===o[0]||2===o[0])){s=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){s.label=o[1];break}if(6===o[0]&&s.label<r[1]){s.label=r[1],r=o;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(o);break}r[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],i=0}finally{n=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}}function E(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],i=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&i>=e.length&&(e=void 0),{value:e&&e[i++],done:!e}}};throw TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}var S=/*#__PURE__*/function(e){"use strict";var f;function h(e){var n,o,s,a,c=e.appId,l=e.appKey,p=e.wepinModal,d=e.wepinStorage;return!function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,h),o=_(o=h),g(a=(n=y()?Reflect.construct(o,[],_(this).constructor):o.apply(this,s))&&("object"==(n&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof n)?n:function(e){if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this),"version",void 0),g(a,"type",void 0),g(a,"wepinAppAttributes",void 0),g(a,"wepinDomain",void 0),g(a,"specifiedEmail",void 0),g(a,"_wepinLifeCycle",void 0),g(a,"_isInitialized",void 0),g(a,"_modeByAppKey",void 0),g(a,"_wepinAppId",void 0),g(a,"_wepinAppKey",void 0),g(a,"_widget",void 0),g(a,"_wepinModal",void 0),g(a,"_wepinStorage",void 0),g(a,"_wepinFetch",void 0),g(a,"_accountInfo",void 0),g(a,"_detailAccount",void 0),g(a,"_userInfo",void 0),g(a,"webviewEventHandler",void 0),g(a,"wepinRequest",void 0),a.version=u.version,console.log("WepinWeb SDK v".concat(a.version)),a._isInitialized=!1,a.wepinLifeCycle="not_initialized",a._wepinAppId=c,a._wepinAppKey=l,a._wepinModal=p||new i.WepinModal,a._wepinStorage=d||new r.default,a.type=a._wepinStorage.platform,a._modeByAppKey=(0,t.getModeByAppKey)(l),a.webviewEventHandler=new t.WebviewEventHandler({checkValidEvent:function(e){return!!(a.wepinWidget.url.includes("/wepin-sdk-login")||a.wepinWidget.url.includes(e.origin))||e.origin===a.wepinWidget.url}}),a.initEventHandler(),a}return!function(e,t){if("function"!=typeof t&&null!==t)throw TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&v(e,t)}(h,e),f=[{key:"initEventHandler",value:function(){var e,n,i=this;n="local_ak_dev_"===this._wepinAppKey.slice(0,13)?this._wepinAppKey.slice(6):this._wepinAppKey,this.webviewEventHandler.addRequestHandler("ready_to_widget",function(e){i.wepinStorage.getAllLocalStorage(i._wepinAppId).then(function(r){var o,s,a,u=Object.assign({},i.wepinAppAttributes),c=(null===(o=i.wepinAppAttributes.loginProviders)||void 0===o?void 0:o.length)||(null===(s=i.wepinAppAttributes.loginProviders)||void 0===s?void 0:s.length)===0?Array.from(i.wepinAppAttributes.loginProviders):void 0;u.loginProviders=c;var l=(0,t.makeWepinResponseMessage)(e,"SUCCESS",{appKey:n,appId:i._wepinAppId,domain:i.wepinDomain,platform:t.Platform[i.type],attributes:u,version:i.version.includes("-alpha")?i.version.substring(0,i.version.indexOf("-")):i.version,type:"".concat(i.type,"-sdk"),localDate:null!=r?r:{}});(null===(a=i.wepinWidget)||void 0===a?void 0:a.isOpen)&&i.wepinWidget.response(l)})}),this.webviewEventHandler.addRequestHandler("close_wepin_widget",function(){i.wepinWidget&&(i.wepinWidget.close(),i.wepinWidget=void 0)});var r=this;this.webviewEventHandler.addRequestHandler("set_local_storage",(e=w(function(e){var n,i,o,s,a;return b(this,function(u){switch(u.label){case 0:return[4,r.wepinStorage.setAllLocalStorage(r._wepinAppId,e.body.parameter.data)];case 1:if(u.sent(),e.body.parameter.data&&e.body.parameter.data.user_info&&(o=e.body.parameter.data.user_info,s=e.body.parameter.data.user_status,o.userStatus=s,o.token=null===(i=e.body.parameter.data)||void 0===i?void 0:i["wepin:connectUser"],r.setUserInfo(o,!0)),!(e.body.parameter.data&&e.body.parameter.data["wepin:connectUser"]))return[3,3];return[4,r.setToken(e.body.parameter.data["wepin:connectUser"])];case 2:u.sent(),u.label=3;case 3:return a=(0,t.makeWepinResponseMessage)(e,"SUCCESS",""),(null===(n=r.wepinWidget)||void 0===n?void 0:n.isOpen)&&r.wepinWidget.response(a),[2]}})}),function(t){return e.apply(this,arguments)})),this.webviewEventHandler.addRequestHandler("set_user_email",function(e){var n,r=(0,t.makeWepinResponseMessage)(e,"SUCCESS",{email:i.specifiedEmail});(null===(n=i.wepinWidget)||void 0===n?void 0:n.isOpen)&&i.wepinWidget.response(r)})}},{key:"wepinLifeCycle",get:function(){return this._wepinLifeCycle},set:function(e){if(e!==this._wepinLifeCycle){if(this._wepinLifeCycle=e,"login"===this._wepinLifeCycle||"login_before_register"===this._wepinLifeCycle){this.emit(c.WEPIN_SDK_EVENTS.WEPIN_LIFECYCLE_CHANGE,e,this._userInfo);return}this.emit(c.WEPIN_SDK_EVENTS.WEPIN_LIFECYCLE_CHANGE,e)}}},{key:"modeByAppKey",get:function(){if(void 0===this._modeByAppKey)throw Error("Wepin.modeByAppKey: wepin widget has to be initialized");return this._modeByAppKey}},{key:"toJSON",value:function(){return""}},{key:"wepinStorage",get:function(){return this._wepinStorage}},{key:"init",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{type:"hide",defaultLanguage:s.WEPIN_DEFAULT_LANG,defaultCurrency:s.WEPIN_DEFAULT_CURRENCY},i=this;return w(function(){var r,o,a,u,c,l;return b(this,function(p){switch(p.label){case 0:if(i._isInitialized)throw Error("Wepin is already initialized!");if(r=e.loginProviders,o=e.defaultLanguage,a=e.defaultCurrency,u=e.type,r&&!r.every(function(e){return t.OAUTH2.includes(e)}))throw Error("Invalid Login provider");return i.wepinAppAttributes={type:null!=u?u:"hide",defaultLanguage:null!=o?o:s.WEPIN_DEFAULT_LANG,defaultCurrency:null!=a?a:s.WEPIN_DEFAULT_CURRENCY,loginProviders:r},i.wepinDomain=i._wepinModal.domain,i._isInitialized=!1,i.wepinLifeCycle="initializing",i._wepinFetch=new n.WepinFetch({appId:i._wepinAppId,appKey:i._wepinAppKey,domain:i.wepinDomain,sdk:{version:i.version,type:"".concat(i.type,"-sdk")},storage:i._wepinStorage}),[4,i._wepinFetch.init()];case 1:return p.sent(),[4,i._wepinFetch.wepinApi.app.getAppInfo({platform:n.WepinPlatformType[i.type],withNetwork:!1})];case 2:if(c=p.sent(),(0,n.isErrorResponse)(c))throw Error(c.message);return i._wepinAppId=i._wepinFetch.appId=c.appInfo.id,[4,i._wepinStorage.getLocalStorage(i._wepinAppId,"wepin:connectUser")];case 3:if(!(l=p.sent()))return[3,5];return[4,i._wepinFetch.setToken(l)];case 4:p.sent(),p.label=5;case 5:return i._isInitialized=!0,[4,i.checkExpiredToken()];case 6:return p.sent(),[2]}})})()}},{key:"wepinWidget",get:function(){return this._widget},set:function(e){this._widget=e}},{key:"isInitialized",value:function(){return!!this._isInitialized}},{key:"changeLanguage",value:function(e){var t=e.currency,n=e.language;this.wepinAppAttributes.defaultCurrency=t,this.wepinAppAttributes.defaultLanguage=n}},{key:"openWidget",value:function(){var e=this;return w(function(){return b(this,function(t){switch(t.label){case 0:return[4,e.getStatus()];case 1:if("login"!==t.sent())throw Error("Wepin.openWidget: You can open it only if you are logged in to the wepin.");return[4,e.openWithoutRequestWepinWidget()];case 2:return t.sent(),[2]}})})()}},{key:"_open",value:function(e){var n=this;return w(function(){var i,r;return b(this,function(o){switch(o.label){case 0:if(o.trys.push([0,7,,8]),i=(0,t.getUrlsByMode)(n._modeByAppKey).wepinWebview,n._widget&&n._widget.isOpen)return[2];if((null==e?void 0:e.url)&&(i+=e.url),!((null==e?void 0:e.isHide)||"show"!==n.wepinAppAttributes.type&&(null==e?void 0:e.isInit)))return[3,2];return[4,n._wepinModal.openModal(i,n.webviewEventHandler.getEventListenerFunction(),{isHide:!0})];case 1:case 3:return n._widget=o.sent(),[3,6];case 2:if((null==e?void 0:e.type)!=="WINDOW")return[3,4];return[4,n._wepinModal.openAuthBrowser(i,n.webviewEventHandler.getEventListenerFunction())];case 4:return[4,n._wepinModal.openModal(i,n.webviewEventHandler.getEventListenerFunction())];case 5:n._widget=o.sent(),o.label=6;case 6:return[3,8];case 7:throw r=o.sent(),d.default.error(r),Error("Wepin.openWidget: Can't open wepin sdk widget");case 8:return[2]}})})()}},{key:"openWithoutRequestWepinWidget",value:function(e){var n,i=this;return new Promise((n=w(function(n){return b(this,function(r){return i.webviewEventHandler.addRequestHandler("get_sdk_request",function(e){var r=(0,t.makeWepinResponseMessage)((0,t.proxyToObject)(e),"SUCCESS","No request");i._widget.response(r),n()},!0),i._open(e),[2]})}),function(e){return n.apply(this,arguments)}))}},{key:"openAndRequestWepinWidget",value:function(e,n){var i,r=Date.now()+Math.random(),o={header:{id:r,request_from:"web",request_to:"wepin_widget"},body:e},s=this;return new Promise((i=w(function(i,a){return b(this,function(u){return s.webviewEventHandler.addRequestHandler("get_sdk_request",function(n){var u,c=(0,t.makeWepinResponseMessage)((0,t.proxyToObject)(n),"SUCCESS",e?o:"No request");(null===(u=s._widget)||void 0===u?void 0:u.isOpen)&&(s.webviewEventHandler.addResponseHandler(r.toString(),function(e){if(s._close(),"ERROR"===e.body.state){a(Error(e.body.data));return}i(e)},!0),s._widget.response(c))},!0),s._open(n),[2]})}),function(e,t){return i.apply(this,arguments)}))}},{key:"closeWidget",value:function(){if(!this._isInitialized)throw Error("Wepin.closeWidget: wepin sdk has to be initialized");if(this._widget)this._close();else throw Error("Wepin.closeWidget: wepin sdk widget is not exist")}},{key:"_close",value:function(){this.removeAllListeners("onUserInfoSet"),this.wepinRequest&&this.removeAllListeners(this.wepinRequest.header.id.toString()),this._widget&&(this._widget.close(),this._widget=void 0),this.specifiedEmail=void 0}},{key:"setToken",value:function(e){var t=this;return w(function(){return b(this,function(n){switch(n.label){case 0:return[4,t._wepinFetch.setToken(e)];case 1:return n.sent(),[2]}})})()}},{key:"checkExpiredToken",value:function(){var e=this;return w(function(){var t,i,r;return b(this,function(s){switch(s.label){case 0:return s.trys.push([0,8,,9]),[4,e._wepinStorage.getLocalStorage(e._wepinAppId,"wepin:connectUser")];case 1:if(!(t=s.sent()))return e.wepinLifeCycle="initialized",[2,!0];if(!((0,o.jwtDecode)(t.accessToken).exp<Math.floor(Date.now()/1e3)+60))return[3,6];return[4,e._wepinFetch.setToken(t)];case 2:return s.sent(),[4,e._wepinStorage.getLocalStorage(e._wepinAppId,"user_id")];case 3:return i=s.sent(),[4,e._wepinFetch.wepinApi.user.refreshToken({userId:i})];case 4:if(r=s.sent(),(0,n.isErrorResponse)(r))return e.wepinLifeCycle="initialized",[2,!0];return t.accessToken=r.token,[4,e._wepinStorage.setLocalStorage(e._wepinAppId,"wepin:connectUser",t)];case 5:s.sent(),s.label=6;case 6:return[4,e.getWepinUserInfo()];case 7:return s.sent(),[2,!1];case 8:return s.sent(),[2,!0];case 9:return[2]}})})()}},{key:"loginWithUI",value:function(e){var t=this;return w(function(){var n,i;return b(this,function(r){switch(r.label){case 0:if(!t._isInitialized)throw Error("Wepin.loginWithUI: wepin sdk has to be initialized");return[4,t._wepinStorage.getLocalStorage(t._wepinAppId,"wepin:connectUser")];case 1:return n=r.sent(),[4,t._wepinStorage.getLocalStorage(t._wepinAppId,"user_info")];case 2:if(i=r.sent(),null==e?void 0:e.email){if(!a.emailRegExp.test(null==e?void 0:e.email))throw Error("Wepin.loginWithUI: The email does not match the correct format.");t.specifiedEmail=null==e?void 0:e.email}else t.specifiedEmail=void 0;if(t.wepinLifeCycle="before_login",!(n&&i))return[3,6];if(!(i&&(null==n?void 0:n.refreshToken)&&(null==e?void 0:e.email)&&(null==i?void 0:i.userInfo.email)!==(null==e?void 0:e.email)))return[3,4];return[4,t.logout()];case 3:r.sent(),r.label=4;case 4:if(!(null==n?void 0:n.refreshToken))return[3,6];return[4,t.checkExpiredToken()];case 5:if(!r.sent()&&i&&"success"===i.status)return[2,t._userInfo];r.label=6;case 6:return[4,t.openWithoutRequestWepinWidget()];case 7:return r.sent(),[2,new Promise(function(e,n){t.once("onUserInfoSet",/*#__PURE__*/w(function(){var i;return b(this,function(r){switch(r.label){case 0:return r.trys.push([0,4,,5]),[4,t._wepinStorage.getLocalStorage(t._wepinAppId,"wepin:connectUser")];case 1:if(i=r.sent(),t._close(),t.specifiedEmail=void 0,!i)return n(Error("User canceled login")),[2];return[4,t._wepinFetch.setToken(i)];case 2:return r.sent(),[4,t.getWepinUserInfo()];case 3:return r.sent(),e(t._userInfo),[3,5];case 4:return n(Error(r.sent())),[3,5];case 5:return[2]}})}))})]}})})()}},{key:"getWepinUserInfo",value:function(e){var t=this;return w(function(){var n,i,r;return b(this,function(o){switch(o.label){case 0:return[4,t._wepinStorage.getLocalStorage(t._wepinAppId,"user_info")];case 1:return n=o.sent(),[4,t._wepinStorage.getLocalStorage(t._wepinAppId,"user_status")];case 2:return i=o.sent(),[4,t._wepinStorage.getLocalStorage(t._wepinAppId,"wepin:connectUser")];case 3:if(r=o.sent(),!e)return[3,8];return n.walletId=e,[4,t._wepinStorage.setLocalStorage(t._wepinAppId,"user_status",{loginStatus:"complete"})];case 4:return o.sent(),[4,t._wepinStorage.setLocalStorage(t._wepinAppId,"user_info",n)];case 5:return o.sent(),[4,t._wepinStorage.setLocalStorage(t._wepinAppId,"wallet_id",e)];case 6:return o.sent(),[4,t._wepinStorage.setLocalStorage(t._wepinAppId,"user_status",{loginStatus:"complete"})];case 7:o.sent(),o.label=8;case 8:return t._userInfo=Object.assign(n,{userStatus:i,token:r}),n&&"success"===n.status?i&&"complete"===i.loginStatus?t.wepinLifeCycle="login":t.wepinLifeCycle="login_before_register":t.wepinLifeCycle="initialized",[2,t._userInfo]}})})()}},{key:"register",value:function(){var e=this;return w(function(){var t,i,r,o,s,a,u,c;return b(this,function(l){switch(l.label){case 0:if(!e._isInitialized)throw Error("Wepin.register: wepin sdk has to be initialized");return[4,e._wepinStorage.getLocalStorage(e._wepinAppId,"user_status")];case 1:return("registerRequired"===(t=l.sent()).loginStatus||"pinRequired"===t.loginStatus)&&e.wepinLifeCycle,[4,e.getStatus()];case 2:if("login_before_register"!==l.sent())throw Error("Wepin.register: The LifeCycle of wepin sdk has to be login_before_register");if("registerRequired"!==t.loginStatus&&"pinRequired"!==t.loginStatus)throw Error("Wepin.register: invalid login status");if(!("registerRequired"===t.loginStatus&&!t.pinRequired))return[3,8];return[4,e._wepinStorage.getLocalStorage(e._wepinAppId,"user_id")];case 3:return i=l.sent(),[4,e._wepinStorage.getLocalStorage(e._wepinAppId,"wallet_id")];case 4:return r=l.sent(),[4,e._wepinFetch.wepinApi.app.register({appId:e._wepinAppId,userId:i,walletId:r,loginStatus:t.loginStatus})];case 5:if(o=l.sent(),(0,n.isErrorResponse)(o))throw Error(o.message);return[4,e._wepinFetch.wepinApi.user.updateTermsAccepted({userId:i},{termsAccepted:{termsOfService:!0,privacyPolicy:!0}})];case 6:if(s=l.sent(),(0,n.isErrorResponse)(s)||!Object.values(s.termsAccepted).every(function(e){return!0===e}))throw Error("unknown/updateTermsAccepted");return[4,e.getWepinUserInfo(o.walletId)];case 7:case 10:return[2,l.sent()];case 8:return[4,e.openAndRequestWepinWidget({command:"register_wepin",parameter:{loginStatus:t.loginStatus,pinRequired:t.pinRequired}},{url:"/sdk-register"})];case 9:if("SUCCESS"!==(a=l.sent()).body.state)return[3,11];return c=null===(u=a.body.data)||void 0===u?void 0:u.walletId,[4,e.getWepinUserInfo(c)];case 11:if(a.body.data)throw Error("Wepin.register: ".concat(a.body.data));throw Error("unknown/error");case 12:return[2]}})})()}},{key:"registerUserEmail",value:function(e){var t=this;return w(function(){return b(this,function(n){return[2,new Promise(function(n,i){t.once("onUserInfoSet",function(e){t._close(),n(e)}),t.openAndRequestWepinWidget({command:"register_user_email",parameter:{provider:e.provider,idToken:e.idToken,accessToken:e.accessToken}}).catch(i)})]})})()}},{key:"logout",value:function(){var e=this;return w(function(){var t;return b(this,function(n){switch(n.label){case 0:return[4,e.getStatus()];case 1:if(t=n.sent(),!e._isInitialized)throw Error("Wepin.logout: wepin sdk has to be initialized");if("login"!==t&&"login_before_register"!==t)throw Error("Wepin.logout: Only if you're logged in to the wepin");return[4,e._wepinStorage.clearAllLocalStorage(e._wepinAppId)];case 2:return n.sent(),e.wepinLifeCycle="initialized",e._userInfo=void 0,e._accountInfo=void 0,e._detailAccount=void 0,[2]}})})()}},{key:"getAccounts",value:function(e){var t=this;return w(function(){var i,r,o;return b(this,function(s){switch(s.label){case 0:if(!t._isInitialized)throw Error("Wepin.getAccounts: wepin sdk has to be initialized");return[4,t.getStatus()];case 1:if("login"!==s.sent())throw Error("Wepin.getAccounts: Only if you're logged in to the wepin");return[4,t._wepinStorage.getLocalStorage(t._wepinAppId,"user_id")];case 2:return i=s.sent(),[4,t._wepinStorage.getLocalStorage(t._wepinAppId,"wallet_id")];case 3:return r=s.sent(),[4,t._wepinFetch.wepinApi.account.getAppAccountList({userId:i,walletId:r,localeId:"ko"===t.wepinAppAttributes.defaultLanguage?1:"ja"===t.wepinAppAttributes.defaultLanguage?3:2})];case 4:if(o=s.sent(),(0,n.isErrorResponse)(o))throw Error(o.message);if(t._detailAccount=(0,p.filterAccountList)(o,null==e?void 0:e.withEoa),t._accountInfo=(0,p.getAccountSDK)(t._detailAccount),(null==e?void 0:e.networks)!==void 0&&(null==e?void 0:e.networks.length)>0)return[2,t._accountInfo.filter(function(t){return(null==e?void 0:e.networks.findIndex(function(e){return e===t.network}))>=0})];return[2,t._accountInfo]}})})()}},{key:"setUserInfo",value:function(e,t){this._userInfo=e,e&&"success"===e.status?e.userStatus&&"complete"===e.userStatus.loginStatus?this.wepinLifeCycle="login":this.wepinLifeCycle="login_before_register":this.wepinLifeCycle="initialized",t&&this.emit("onUserInfoSet",e)}},{key:"getStatus",value:function(){var e=this;return w(function(){return b(this,function(t){switch(t.label){case 0:return[4,e.checkExpiredToken()];case 1:return t.sent(),[2,e.wepinLifeCycle]}})})()}},{key:"getBalance",value:function(e){var t=this;return w(function(){var i,r,o,s,a,u,c,p,d,f,w,g,_,h,v;return b(this,function(y){switch(y.label){case 0:if(!t._isInitialized)throw Error("Wepin.getBalance: wepin sdk has to be initialized");return[4,t.getStatus()];case 1:if("login"!==y.sent())throw Error("Wepin.getBalance: Only if you're logged in to the wepin.");return i=!e||0===e.length,r=[],[4,t.getAccounts()];case 2:if(y.sent(),!i)return[3,11];o=!0,s=!1,a=void 0,y.label=3;case 3:y.trys.push([3,8,9,10]),u=function(){var i,o;return b(this,function(s){switch(s.label){case 0:if(i=p.value,!(e&&e.findIndex(function(e){return e.network===i.network&&e.address===i.address})>=0))return[3,2];return[4,t._wepinFetch.wepinApi.balance.getAccountBalance({accountId:i.accountId})];case 1:if(o=s.sent(),(0,n.isErrorResponse)(o))throw Error(o.message);r.push((0,l.filterAccountBalance)(t._detailAccount,i,o)),s.label=2;case 2:return[2]}})},c=t._detailAccount[Symbol.iterator](),y.label=4;case 4:if(o=(p=c.next()).done)return[3,7];return[5,E(u())];case 5:y.sent(),y.label=6;case 6:return o=!0,[3,4];case 7:return[3,10];case 8:return d=y.sent(),s=!0,a=d,[3,10];case 9:try{o||null==c.return||c.return()}finally{if(s)throw a}return[7];case 10:return[3,19];case 11:f=!0,w=!1,g=void 0,y.label=12;case 12:y.trys.push([12,17,18,19]),_=function(){var e,i,o;return b(this,function(s){switch(s.label){case 0:if(e=v.value,!(i=t._detailAccount.find(function(t){return e.network===t.network&&e.address===t.address})))throw Error("Wepin.getBalance: Account not found");return[4,t._wepinFetch.wepinApi.balance.getAccountBalance({accountId:i.accountId})];case 1:if(o=s.sent(),(0,n.isErrorResponse)(o))throw Error(o.message);return r.push((0,l.filterAccountBalance)(t._detailAccount,i,o)),[2]}})},h=e[Symbol.iterator](),y.label=13;case 13:if(f=(v=h.next()).done)return[3,16];return[5,E(_())];case 14:y.sent(),y.label=15;case 15:return f=!0,[3,13];case 16:return[3,19];case 17:return d=y.sent(),w=!0,g=d,[3,19];case 18:try{f||null==h.return||h.return()}finally{if(w)throw g}return[7];case 19:if(!r.length)throw Error("Wepin.getBalance: Account not found");return[2,r]}})})()}},{key:"getSDKRequest",value:function(){return this.wepinRequest}},{key:"send",value:function(e){var t=e.account,n=e.txData,i=this;return w(function(){var e,r,o;return b(this,function(s){switch(s.label){case 0:if(!i._isInitialized)throw Error("Wepin.send: wepin sdk has to be initialized");return[4,i.getStatus()];case 1:if("login"!==s.sent())throw Error("Wepin.send: Only if you're logged in to the wepin");return i.emit(c.WEPIN_SDK_EVENTS.SEND_IN_PROGRESS),[4,i.getAccounts()];case 2:if(s.sent(),!i._detailAccount.find(function(e){return t.network===e.network&&t.address===e.address}))throw i.emit(c.WEPIN_SDK_EVENTS.SEND_COMPLETE,!1,"Account not found"),Error("Wepin.send: Account not found");return[4,i.openAndRequestWepinWidget({command:"send_transaction_without_provider",parameter:{account:{address:t.address,network:t.network,contract:null==t?void 0:t.contract},from:t.address,to:null==n?void 0:n.toAddress,value:null==n?void 0:n.amount}},{url:"/sdk-send"})];case 3:if(r="SUCCESS"===(e=s.sent()).body.state,i.wepinRequest=void 0,r)return o=e.body.data,i.emit(c.WEPIN_SDK_EVENTS.SEND_COMPLETE,r,o),[2,{txId:o}];if(e.body.data)throw i.emit(c.WEPIN_SDK_EVENTS.SEND_COMPLETE,r,e.body.data),Error("Wepin.send: ".concat(e.body.data));throw i.emit(c.WEPIN_SDK_EVENTS.SEND_COMPLETE,r,"unknown/error"),Error("unknown/error")}})})()}},{key:"getLoginSession",value:function(e){var t=this;return w(function(){var i,r,o,s,a;return b(this,function(u){switch(u.label){case 0:if(!e)return[3,4];return i=e.firebaseToken,[4,t._wepinFetch.wepinFirebaseApi.getRefreshIdToken(i.refreshToken)];case 1:return r=u.sent(),[4,t._wepinFetch.wepinApi.user.login({idToken:r})];case 2:if(o=u.sent(),(0,n.isErrorResponse)(o))throw Error("Wepin.getLoginSession: wepin login fail");return[4,t._wepinStorage.setLoginUserLocalStorage(t._wepinAppId,{provider:i.provider,token:{idToken:r,refreshToken:i.refreshToken}},o)];case 3:u.sent(),u.label=4;case 4:return[4,t._wepinStorage.getLocalStorage(t._wepinAppId,"firebase:wepin")];case 5:return s=u.sent(),[4,t._wepinStorage.getLocalStorage(t._wepinAppId,"wepin:connectUser")];case 6:return a=u.sent(),[2,{firebaseToken:s,wepinToken:a}]}})})()}},{key:"finalize",value:function(){var e=this;return w(function(){return b(this,function(t){switch(t.label){case 0:return e._close(),[4,e._wepinStorage.clearAllLocalStorage(e._wepinAppId)];case 1:return t.sent(),e._isInitialized=!1,e.wepinLifeCycle="not_initialized",e._userInfo=void 0,e._accountInfo=void 0,e._detailAccount=void 0,e.specifiedEmail=void 0,[2]}})})()}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}(h.prototype,f),h}(e.default);