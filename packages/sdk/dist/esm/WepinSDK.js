function e(e,t,n,i,r,o,a){try{var s=e[o](a),u=s.value}catch(e){n(e);return}s.done?t(u):Promise.resolve(u).then(i,r)}function t(t){return function(){var n=this,i=arguments;return new Promise(function(r,o){var a=t.apply(n,i);function s(t){e(a,r,o,s,u,"next",t)}function u(t){e(a,r,o,s,u,"throw",t)}s(void 0)})}}function n(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e){return(i=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function r(e,t){return(r=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function o(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(o=function(){return!!e})()}function a(e,t){var n,i,r,o,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(n)throw TypeError("Generator is already executing.");for(;a;)try{if(n=1,i&&(r=2&o[0]?i.return:o[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,o[1])).done)return r;switch(i=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,i=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(r=(r=a.trys).length>0&&r[r.length-1])&&(6===o[0]||2===o[0])){a=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){a.label=o[1];break}if(6===o[0]&&a.label<r[1]){a.label=r[1],r=o;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(o);break}r[2]&&a.ops.pop(),a.trys.pop();continue}o=t.call(e,a)}catch(e){o=[6,e],i=0}finally{n=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}}function s(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],i=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&i>=e.length&&(e=void 0),{value:e&&e[i++],done:!e}}};throw TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}import u from"@metamask/safe-event-emitter";import{getUrlsByMode as c,getModeByAppKey as l,WebviewEventHandler as p,Platform as d,proxyToObject as f,makeWepinResponseMessage as w,OAUTH2 as g}from"@wepin/common";import{WepinFetch as h,isErrorResponse as _,WepinPlatformType as v}from"@wepin/fetch-js";import{WepinModal as y}from"@wepin/modal-js";import b from"@wepin/storage-js";import{jwtDecode as m}from"jwt-decode";import{WEPIN_DEFAULT_CURRENCY as S,WEPIN_DEFAULT_LANG as A}from"./const/config.js";import{emailRegExp as k}from"./const/regExp.js";import{version as I}from"./const/version.js";import{WEPIN_SDK_EVENTS as E}from"./types/index.js";import{filterAccountBalance as W}from"./utils/accountBalance.js";import{filterAccountList as L,getAccountSDK as C}from"./utils/accounts.js";import T from"./utils/log.js";export var WepinSDK=/*#__PURE__*/function(e){var u;function R(e){var t,r,a,s,u=e.appId,c=e.appKey,d=e.wepinModal,f=e.wepinStorage;return!function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,R),r=i(r=R),n(s=(t=o()?Reflect.construct(r,[],i(this).constructor):r.apply(this,a))&&("object"==(t&&"undefined"!=typeof Symbol&&t.constructor===Symbol?"symbol":typeof t)||"function"==typeof t)?t:function(e){if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this),"version",void 0),n(s,"type",void 0),n(s,"wepinAppAttributes",void 0),n(s,"wepinDomain",void 0),n(s,"specifiedEmail",void 0),n(s,"_wepinLifeCycle",void 0),n(s,"_isInitialized",void 0),n(s,"_modeByAppKey",void 0),n(s,"_wepinAppId",void 0),n(s,"_wepinAppKey",void 0),n(s,"_widget",void 0),n(s,"_wepinModal",void 0),n(s,"_wepinStorage",void 0),n(s,"_wepinFetch",void 0),n(s,"_accountInfo",void 0),n(s,"_detailAccount",void 0),n(s,"_userInfo",void 0),n(s,"webviewEventHandler",void 0),n(s,"wepinRequest",void 0),s.version=I,console.log("WepinWeb SDK v".concat(s.version)),s._isInitialized=!1,s.wepinLifeCycle="not_initialized",s._wepinAppId=u,s._wepinAppKey=c,s._wepinModal=d||new y,s._wepinStorage=f||new b,s.type=s._wepinStorage.platform,s._modeByAppKey=l(c),s.webviewEventHandler=new p({checkValidEvent:function(e){return!!(s.wepinWidget.url.includes("/wepin-sdk-login")||s.wepinWidget.url.includes(e.origin))||e.origin===s.wepinWidget.url}}),s.initEventHandler(),s}return!function(e,t){if("function"!=typeof t&&null!==t)throw TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&r(e,t)}(R,e),u=[{key:"initEventHandler",value:function(){var e,n,i=this;n="local_ak_dev_"===this._wepinAppKey.slice(0,13)?this._wepinAppKey.slice(6):this._wepinAppKey,this.webviewEventHandler.addRequestHandler("ready_to_widget",function(e){i.wepinStorage.getAllLocalStorage(i._wepinAppId).then(function(t){var r,o,a,s=Object.assign({},i.wepinAppAttributes),u=(null===(r=i.wepinAppAttributes.loginProviders)||void 0===r?void 0:r.length)||(null===(o=i.wepinAppAttributes.loginProviders)||void 0===o?void 0:o.length)===0?Array.from(i.wepinAppAttributes.loginProviders):void 0;s.loginProviders=u;var c=w(e,"SUCCESS",{appKey:n,appId:i._wepinAppId,domain:i.wepinDomain,platform:d[i.type],attributes:s,version:i.version.includes("-alpha")?i.version.substring(0,i.version.indexOf("-")):i.version,type:"".concat(i.type,"-sdk"),localDate:null!=t?t:{}});(null===(a=i.wepinWidget)||void 0===a?void 0:a.isOpen)&&i.wepinWidget.response(c)})}),this.webviewEventHandler.addRequestHandler("close_wepin_widget",function(){i.wepinWidget&&(i.wepinWidget.close(),i.wepinWidget=void 0)});var r=this;this.webviewEventHandler.addRequestHandler("set_local_storage",(e=t(function(e){var t,n,i,o,s;return a(this,function(a){switch(a.label){case 0:return[4,r.wepinStorage.setAllLocalStorage(r._wepinAppId,e.body.parameter.data)];case 1:if(a.sent(),e.body.parameter.data&&e.body.parameter.data.user_info&&(i=e.body.parameter.data.user_info,o=e.body.parameter.data.user_status,i.userStatus=o,i.token=null===(n=e.body.parameter.data)||void 0===n?void 0:n["wepin:connectUser"],r.setUserInfo(i,!0)),!(e.body.parameter.data&&e.body.parameter.data["wepin:connectUser"]))return[3,3];return[4,r.setToken(e.body.parameter.data["wepin:connectUser"])];case 2:a.sent(),a.label=3;case 3:return s=w(e,"SUCCESS",""),(null===(t=r.wepinWidget)||void 0===t?void 0:t.isOpen)&&r.wepinWidget.response(s),[2]}})}),function(t){return e.apply(this,arguments)})),this.webviewEventHandler.addRequestHandler("set_user_email",function(e){var t,n=w(e,"SUCCESS",{email:i.specifiedEmail});(null===(t=i.wepinWidget)||void 0===t?void 0:t.isOpen)&&i.wepinWidget.response(n)})}},{key:"wepinLifeCycle",get:function(){return this._wepinLifeCycle},set:function(e){if(e!==this._wepinLifeCycle){if(this._wepinLifeCycle=e,"login"===this._wepinLifeCycle||"login_before_register"===this._wepinLifeCycle){this.emit(E.WEPIN_LIFECYCLE_CHANGE,e,this._userInfo);return}this.emit(E.WEPIN_LIFECYCLE_CHANGE,e)}}},{key:"modeByAppKey",get:function(){if(void 0===this._modeByAppKey)throw Error("Wepin.modeByAppKey: wepin widget has to be initialized");return this._modeByAppKey}},{key:"toJSON",value:function(){return""}},{key:"wepinStorage",get:function(){return this._wepinStorage}},{key:"init",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{type:"hide",defaultLanguage:A,defaultCurrency:S},n=this;return t(function(){var t,i,r,o,s,u;return a(this,function(a){switch(a.label){case 0:if(n._isInitialized)throw Error("Wepin is already initialized!");if(t=e.loginProviders,i=e.defaultLanguage,r=e.defaultCurrency,o=e.type,t&&!t.every(function(e){return g.includes(e)}))throw Error("Invalid Login provider");return n.wepinAppAttributes={type:null!=o?o:"hide",defaultLanguage:null!=i?i:A,defaultCurrency:null!=r?r:S,loginProviders:t},n.wepinDomain=n._wepinModal.domain,n._isInitialized=!1,n.wepinLifeCycle="initializing",n._wepinFetch=new h({appId:n._wepinAppId,appKey:n._wepinAppKey,domain:n.wepinDomain,sdk:{version:n.version,type:"".concat(n.type,"-sdk")},storage:n._wepinStorage}),[4,n._wepinFetch.init()];case 1:return a.sent(),[4,n._wepinFetch.wepinApi.app.getAppInfo({platform:v[n.type],withNetwork:!1})];case 2:if(_(s=a.sent()))throw Error(s.message);return n._wepinAppId=n._wepinFetch.appId=s.appInfo.id,[4,n._wepinStorage.getLocalStorage(n._wepinAppId,"wepin:connectUser")];case 3:if(!(u=a.sent()))return[3,5];return[4,n._wepinFetch.setToken(u)];case 4:a.sent(),a.label=5;case 5:return n._isInitialized=!0,[4,n.checkExpiredToken()];case 6:return a.sent(),[2]}})})()}},{key:"wepinWidget",get:function(){return this._widget},set:function(e){this._widget=e}},{key:"isInitialized",value:function(){return!!this._isInitialized}},{key:"changeLanguage",value:function(e){var t=e.currency,n=e.language;this.wepinAppAttributes.defaultCurrency=t,this.wepinAppAttributes.defaultLanguage=n}},{key:"openWidget",value:function(){var e=this;return t(function(){return a(this,function(t){switch(t.label){case 0:return[4,e.getStatus()];case 1:if("login"!==t.sent())throw Error("Wepin.openWidget: You can open it only if you are logged in to the wepin.");return[4,e.openWithoutRequestWepinWidget()];case 2:return t.sent(),[2]}})})()}},{key:"_open",value:function(e){var n=this;return t(function(){var t,i;return a(this,function(r){switch(r.label){case 0:if(r.trys.push([0,7,,8]),t=c(n._modeByAppKey).wepinWebview,n._widget&&n._widget.isOpen)return[2];if((null==e?void 0:e.url)&&(t+=e.url),!((null==e?void 0:e.isHide)||"show"!==n.wepinAppAttributes.type&&(null==e?void 0:e.isInit)))return[3,2];return[4,n._wepinModal.openModal(t,n.webviewEventHandler.getEventListenerFunction(),{isHide:!0})];case 1:case 3:return n._widget=r.sent(),[3,6];case 2:if((null==e?void 0:e.type)!=="WINDOW")return[3,4];return[4,n._wepinModal.openAuthBrowser(t,n.webviewEventHandler.getEventListenerFunction())];case 4:return[4,n._wepinModal.openModal(t,n.webviewEventHandler.getEventListenerFunction())];case 5:n._widget=r.sent(),r.label=6;case 6:return[3,8];case 7:throw i=r.sent(),T.error(i),Error("Wepin.openWidget: Can't open wepin sdk widget");case 8:return[2]}})})()}},{key:"openWithoutRequestWepinWidget",value:function(e){var n,i=this;return new Promise((n=t(function(t){return a(this,function(n){return i.webviewEventHandler.addRequestHandler("get_sdk_request",function(e){var n=w(f(e),"SUCCESS","No request");i._widget.response(n),t()},!0),i._open(e),[2]})}),function(e){return n.apply(this,arguments)}))}},{key:"openAndRequestWepinWidget",value:function(e,n){var i,r=Date.now()+Math.random(),o={header:{id:r,request_from:"web",request_to:"wepin_widget"},body:e},s=this;return new Promise((i=t(function(t,i){return a(this,function(a){return s.webviewEventHandler.addRequestHandler("get_sdk_request",function(n){var a,u=w(f(n),"SUCCESS",e?o:"No request");(null===(a=s._widget)||void 0===a?void 0:a.isOpen)&&(s.webviewEventHandler.addResponseHandler(r.toString(),function(e){if(s._close(),"ERROR"===e.body.state){i(Error(e.body.data));return}t(e)},!0),s._widget.response(u))},!0),s._open(n),[2]})}),function(e,t){return i.apply(this,arguments)}))}},{key:"closeWidget",value:function(){if(!this._isInitialized)throw Error("Wepin.closeWidget: wepin sdk has to be initialized");if(this._widget)this._close();else throw Error("Wepin.closeWidget: wepin sdk widget is not exist")}},{key:"_close",value:function(){this.removeAllListeners("onUserInfoSet"),this.wepinRequest&&this.removeAllListeners(this.wepinRequest.header.id.toString()),this._widget&&(this._widget.close(),this._widget=void 0),this.specifiedEmail=void 0}},{key:"setToken",value:function(e){var n=this;return t(function(){return a(this,function(t){switch(t.label){case 0:return[4,n._wepinFetch.setToken(e)];case 1:return t.sent(),[2]}})})()}},{key:"checkExpiredToken",value:function(){var e=this;return t(function(){var t,n,i;return a(this,function(r){switch(r.label){case 0:return r.trys.push([0,8,,9]),[4,e._wepinStorage.getLocalStorage(e._wepinAppId,"wepin:connectUser")];case 1:if(!(t=r.sent()))return e.wepinLifeCycle="initialized",[2,!0];if(!(m(t.accessToken).exp<Math.floor(Date.now()/1e3)+60))return[3,6];return[4,e._wepinFetch.setToken(t)];case 2:return r.sent(),[4,e._wepinStorage.getLocalStorage(e._wepinAppId,"user_id")];case 3:return n=r.sent(),[4,e._wepinFetch.wepinApi.user.refreshToken({userId:n})];case 4:if(_(i=r.sent()))return e.wepinLifeCycle="initialized",[2,!0];return t.accessToken=i.token,[4,e._wepinStorage.setLocalStorage(e._wepinAppId,"wepin:connectUser",t)];case 5:r.sent(),r.label=6;case 6:return[4,e.getWepinUserInfo()];case 7:return r.sent(),[2,!1];case 8:return r.sent(),[2,!0];case 9:return[2]}})})()}},{key:"loginWithUI",value:function(e){var n=this;return t(function(){var i,r;return a(this,function(o){switch(o.label){case 0:if(!n._isInitialized)throw Error("Wepin.loginWithUI: wepin sdk has to be initialized");return[4,n._wepinStorage.getLocalStorage(n._wepinAppId,"wepin:connectUser")];case 1:return i=o.sent(),[4,n._wepinStorage.getLocalStorage(n._wepinAppId,"user_info")];case 2:if(r=o.sent(),null==e?void 0:e.email){if(!k.test(null==e?void 0:e.email))throw Error("Wepin.loginWithUI: The email does not match the correct format.");n.specifiedEmail=null==e?void 0:e.email}else n.specifiedEmail=void 0;if(n.wepinLifeCycle="before_login",!(i&&r))return[3,6];if(!(r&&(null==i?void 0:i.refreshToken)&&(null==e?void 0:e.email)&&(null==r?void 0:r.userInfo.email)!==(null==e?void 0:e.email)))return[3,4];return[4,n.logout()];case 3:o.sent(),o.label=4;case 4:if(!(null==i?void 0:i.refreshToken))return[3,6];return[4,n.checkExpiredToken()];case 5:if(!o.sent()&&r&&"success"===r.status)return[2,n._userInfo];o.label=6;case 6:return[4,n.openWithoutRequestWepinWidget()];case 7:return o.sent(),[2,new Promise(function(e,i){n.once("onUserInfoSet",/*#__PURE__*/t(function(){var t;return a(this,function(r){switch(r.label){case 0:return r.trys.push([0,4,,5]),[4,n._wepinStorage.getLocalStorage(n._wepinAppId,"wepin:connectUser")];case 1:if(t=r.sent(),n._close(),n.specifiedEmail=void 0,!t)return i(Error("User canceled login")),[2];return[4,n._wepinFetch.setToken(t)];case 2:return r.sent(),[4,n.getWepinUserInfo()];case 3:return r.sent(),e(n._userInfo),[3,5];case 4:return i(Error(r.sent())),[3,5];case 5:return[2]}})}))})]}})})()}},{key:"getWepinUserInfo",value:function(e){var n=this;return t(function(){var t,i,r;return a(this,function(o){switch(o.label){case 0:return[4,n._wepinStorage.getLocalStorage(n._wepinAppId,"user_info")];case 1:return t=o.sent(),[4,n._wepinStorage.getLocalStorage(n._wepinAppId,"user_status")];case 2:return i=o.sent(),[4,n._wepinStorage.getLocalStorage(n._wepinAppId,"wepin:connectUser")];case 3:if(r=o.sent(),!e)return[3,8];return t.walletId=e,[4,n._wepinStorage.setLocalStorage(n._wepinAppId,"user_status",{loginStatus:"complete"})];case 4:return o.sent(),[4,n._wepinStorage.setLocalStorage(n._wepinAppId,"user_info",t)];case 5:return o.sent(),[4,n._wepinStorage.setLocalStorage(n._wepinAppId,"wallet_id",e)];case 6:return o.sent(),[4,n._wepinStorage.setLocalStorage(n._wepinAppId,"user_status",{loginStatus:"complete"})];case 7:o.sent(),o.label=8;case 8:return n._userInfo=Object.assign(t,{userStatus:i,token:r}),t&&"success"===t.status?i&&"complete"===i.loginStatus?n.wepinLifeCycle="login":n.wepinLifeCycle="login_before_register":n.wepinLifeCycle="initialized",[2,n._userInfo]}})})()}},{key:"register",value:function(){var e=this;return t(function(){var t,n,i,r,o,s,u,c;return a(this,function(a){switch(a.label){case 0:if(!e._isInitialized)throw Error("Wepin.register: wepin sdk has to be initialized");return[4,e._wepinStorage.getLocalStorage(e._wepinAppId,"user_status")];case 1:return("registerRequired"===(t=a.sent()).loginStatus||"pinRequired"===t.loginStatus)&&e.wepinLifeCycle,[4,e.getStatus()];case 2:if("login_before_register"!==a.sent())throw Error("Wepin.register: The LifeCycle of wepin sdk has to be login_before_register");if("registerRequired"!==t.loginStatus&&"pinRequired"!==t.loginStatus)throw Error("Wepin.register: invalid login status");if(!("registerRequired"===t.loginStatus&&!t.pinRequired))return[3,8];return[4,e._wepinStorage.getLocalStorage(e._wepinAppId,"user_id")];case 3:return n=a.sent(),[4,e._wepinStorage.getLocalStorage(e._wepinAppId,"wallet_id")];case 4:return i=a.sent(),[4,e._wepinFetch.wepinApi.app.register({appId:e._wepinAppId,userId:n,walletId:i,loginStatus:t.loginStatus})];case 5:if(_(r=a.sent()))throw Error(r.message);return[4,e._wepinFetch.wepinApi.user.updateTermsAccepted({userId:n},{termsAccepted:{termsOfService:!0,privacyPolicy:!0}})];case 6:if(_(o=a.sent())||!Object.values(o.termsAccepted).every(function(e){return!0===e}))throw Error("unknown/updateTermsAccepted");return[4,e.getWepinUserInfo(r.walletId)];case 7:case 10:return[2,a.sent()];case 8:return[4,e.openAndRequestWepinWidget({command:"register_wepin",parameter:{loginStatus:t.loginStatus,pinRequired:t.pinRequired}},{url:"/sdk-register"})];case 9:if("SUCCESS"!==(s=a.sent()).body.state)return[3,11];return c=null===(u=s.body.data)||void 0===u?void 0:u.walletId,[4,e.getWepinUserInfo(c)];case 11:if(s.body.data)throw Error("Wepin.register: ".concat(s.body.data));throw Error("unknown/error");case 12:return[2]}})})()}},{key:"registerUserEmail",value:function(e){var n=this;return t(function(){return a(this,function(t){return[2,new Promise(function(t,i){n.once("onUserInfoSet",function(e){n._close(),t(e)}),n.openAndRequestWepinWidget({command:"register_user_email",parameter:{provider:e.provider,idToken:e.idToken,accessToken:e.accessToken}}).catch(i)})]})})()}},{key:"logout",value:function(){var e=this;return t(function(){var t;return a(this,function(n){switch(n.label){case 0:return[4,e.getStatus()];case 1:if(t=n.sent(),!e._isInitialized)throw Error("Wepin.logout: wepin sdk has to be initialized");if("login"!==t&&"login_before_register"!==t)throw Error("Wepin.logout: Only if you're logged in to the wepin");return[4,e._wepinStorage.clearAllLocalStorage(e._wepinAppId)];case 2:return n.sent(),e.wepinLifeCycle="initialized",e._userInfo=void 0,e._accountInfo=void 0,e._detailAccount=void 0,[2]}})})()}},{key:"getAccounts",value:function(e){var n=this;return t(function(){var t,i,r;return a(this,function(o){switch(o.label){case 0:if(!n._isInitialized)throw Error("Wepin.getAccounts: wepin sdk has to be initialized");return[4,n.getStatus()];case 1:if("login"!==o.sent())throw Error("Wepin.getAccounts: Only if you're logged in to the wepin");return[4,n._wepinStorage.getLocalStorage(n._wepinAppId,"user_id")];case 2:return t=o.sent(),[4,n._wepinStorage.getLocalStorage(n._wepinAppId,"wallet_id")];case 3:return i=o.sent(),[4,n._wepinFetch.wepinApi.account.getAppAccountList({userId:t,walletId:i,localeId:"ko"===n.wepinAppAttributes.defaultLanguage?1:"ja"===n.wepinAppAttributes.defaultLanguage?3:2})];case 4:if(_(r=o.sent()))throw Error(r.message);if(n._detailAccount=L(r,null==e?void 0:e.withEoa),n._accountInfo=C(n._detailAccount),(null==e?void 0:e.networks)!==void 0&&(null==e?void 0:e.networks.length)>0)return[2,n._accountInfo.filter(function(t){return(null==e?void 0:e.networks.findIndex(function(e){return e===t.network}))>=0})];return[2,n._accountInfo]}})})()}},{key:"setUserInfo",value:function(e,t){this._userInfo=e,e&&"success"===e.status?e.userStatus&&"complete"===e.userStatus.loginStatus?this.wepinLifeCycle="login":this.wepinLifeCycle="login_before_register":this.wepinLifeCycle="initialized",t&&this.emit("onUserInfoSet",e)}},{key:"getStatus",value:function(){var e=this;return t(function(){return a(this,function(t){switch(t.label){case 0:return[4,e.checkExpiredToken()];case 1:return t.sent(),[2,e.wepinLifeCycle]}})})()}},{key:"getBalance",value:function(e){var n=this;return t(function(){var t,i,r,o,u,c,l,p,d,f,w,g,h,v,y;return a(this,function(b){switch(b.label){case 0:if(!n._isInitialized)throw Error("Wepin.getBalance: wepin sdk has to be initialized");return[4,n.getStatus()];case 1:if("login"!==b.sent())throw Error("Wepin.getBalance: Only if you're logged in to the wepin.");return t=!e||0===e.length,i=[],[4,n.getAccounts()];case 2:if(b.sent(),!t)return[3,11];r=!0,o=!1,u=void 0,b.label=3;case 3:b.trys.push([3,8,9,10]),c=function(){var t,r;return a(this,function(o){switch(o.label){case 0:if(t=p.value,!(e&&e.findIndex(function(e){return e.network===t.network&&e.address===t.address})>=0))return[3,2];return[4,n._wepinFetch.wepinApi.balance.getAccountBalance({accountId:t.accountId})];case 1:if(_(r=o.sent()))throw Error(r.message);i.push(W(n._detailAccount,t,r)),o.label=2;case 2:return[2]}})},l=n._detailAccount[Symbol.iterator](),b.label=4;case 4:if(r=(p=l.next()).done)return[3,7];return[5,s(c())];case 5:b.sent(),b.label=6;case 6:return r=!0,[3,4];case 7:return[3,10];case 8:return d=b.sent(),o=!0,u=d,[3,10];case 9:try{r||null==l.return||l.return()}finally{if(o)throw u}return[7];case 10:return[3,19];case 11:f=!0,w=!1,g=void 0,b.label=12;case 12:b.trys.push([12,17,18,19]),h=function(){var e,t,r;return a(this,function(o){switch(o.label){case 0:if(e=y.value,!(t=n._detailAccount.find(function(t){return e.network===t.network&&e.address===t.address})))throw Error("Wepin.getBalance: Account not found");return[4,n._wepinFetch.wepinApi.balance.getAccountBalance({accountId:t.accountId})];case 1:if(_(r=o.sent()))throw Error(r.message);return i.push(W(n._detailAccount,t,r)),[2]}})},v=e[Symbol.iterator](),b.label=13;case 13:if(f=(y=v.next()).done)return[3,16];return[5,s(h())];case 14:b.sent(),b.label=15;case 15:return f=!0,[3,13];case 16:return[3,19];case 17:return d=b.sent(),w=!0,g=d,[3,19];case 18:try{f||null==v.return||v.return()}finally{if(w)throw g}return[7];case 19:if(!i.length)throw Error("Wepin.getBalance: Account not found");return[2,i]}})})()}},{key:"getSDKRequest",value:function(){return this.wepinRequest}},{key:"send",value:function(e){var n=e.account,i=e.txData,r=this;return t(function(){var e,t,o;return a(this,function(a){switch(a.label){case 0:if(!r._isInitialized)throw Error("Wepin.send: wepin sdk has to be initialized");return[4,r.getStatus()];case 1:if("login"!==a.sent())throw Error("Wepin.send: Only if you're logged in to the wepin");return r.emit(E.SEND_IN_PROGRESS),[4,r.getAccounts()];case 2:if(a.sent(),!r._detailAccount.find(function(e){return n.network===e.network&&n.address===e.address}))throw r.emit(E.SEND_COMPLETE,!1,"Account not found"),Error("Wepin.send: Account not found");return[4,r.openAndRequestWepinWidget({command:"send_transaction_without_provider",parameter:{account:{address:n.address,network:n.network,contract:null==n?void 0:n.contract},from:n.address,to:null==i?void 0:i.toAddress,value:null==i?void 0:i.amount}},{url:"/sdk-send"})];case 3:if(t="SUCCESS"===(e=a.sent()).body.state,r.wepinRequest=void 0,t)return o=e.body.data,r.emit(E.SEND_COMPLETE,t,o),[2,{txId:o}];if(e.body.data)throw r.emit(E.SEND_COMPLETE,t,e.body.data),Error("Wepin.send: ".concat(e.body.data));throw r.emit(E.SEND_COMPLETE,t,"unknown/error"),Error("unknown/error")}})})()}},{key:"getLoginSession",value:function(e){var n=this;return t(function(){var t,i,r,o,s;return a(this,function(a){switch(a.label){case 0:if(!e)return[3,4];return t=e.firebaseToken,[4,n._wepinFetch.wepinFirebaseApi.getRefreshIdToken(t.refreshToken)];case 1:return i=a.sent(),[4,n._wepinFetch.wepinApi.user.login({idToken:i})];case 2:if(_(r=a.sent()))throw Error("Wepin.getLoginSession: wepin login fail");return[4,n._wepinStorage.setLoginUserLocalStorage(n._wepinAppId,{provider:t.provider,token:{idToken:i,refreshToken:t.refreshToken}},r)];case 3:a.sent(),a.label=4;case 4:return[4,n._wepinStorage.getLocalStorage(n._wepinAppId,"firebase:wepin")];case 5:return o=a.sent(),[4,n._wepinStorage.getLocalStorage(n._wepinAppId,"wepin:connectUser")];case 6:return s=a.sent(),[2,{firebaseToken:o,wepinToken:s}]}})})()}},{key:"finalize",value:function(){var e=this;return t(function(){return a(this,function(t){switch(t.label){case 0:return e._close(),[4,e._wepinStorage.clearAllLocalStorage(e._wepinAppId)];case 1:return t.sent(),e._isInitialized=!1,e.wepinLifeCycle="not_initialized",e._userInfo=void 0,e._accountInfo=void 0,e._detailAccount=void 0,e.specifiedEmail=void 0,[2]}})})()}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}(R.prototype,u),R}(u);